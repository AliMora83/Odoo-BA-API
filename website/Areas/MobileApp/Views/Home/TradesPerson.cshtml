
@{
    ViewBag.Title = "TradesPerson";
    Layout = "~/Areas/MobileApp/Views/Shared/_LayoutMain.cshtml";

    BridgingAfricaDBEntities db = new BridgingAfricaDBEntities();

    int serviceId = int.Parse(Request.QueryString["sid"]);
    int postalcode = int.Parse(Request.QueryString["PostalCodeID"]);
    int cid = int.Parse(Request.QueryString["cid"]);
    int scid = int.Parse(Request.QueryString["scid"]);
    var catename = db.CategoryTbls.Where(c => c.Id == cid).Select(c => c.CategoryName).FirstOrDefault();

    var result = db.ProviderTbls.Where(p => p.IsActive == true && p.IsAvailable == true && p.ProviderServicesTbls.Any(s => s.IsActive) && p.StatusID == 2 && p.PostalCodeID == postalcode && p.ProviderServicesTbls.Any(ps => ps.ServiceID == serviceId && ps.IsActive)).Select(s => new { s.Id, s.ProviderName, s.PostalCodesTbl.AreaName, s.AverageRating, s.ProfileImage, s.BannerImage, s.ContactNo, s.IsSponsored, s.IsVerified, ReviewsCount = s.CustomerReviewsTbls.Count(c => c.IsActive == true), Services = s.ProviderServicesTbls.Where(ss => ss.IsActive == true && ss.ServiceTbl.IsActive == true).Select(ss => ss.ServiceTbl.ServiceName) }).OrderByDescending(s => s.ReviewsCount).ToList();
}
<div class="page-content">
    <div class="page-title page-title-small">
        <h2><a href="/MobileApp/Home/SearchArea?scid=@Request.QueryString["scid"]&cid=@Request.QueryString["cid"]&sid=@Request.QueryString["sid"]"><i class="fa fa-arrow-left"></i></a>Tradesperson in your area</h2>
    </div>
    <div class="card header-card shape-rounded" data-card-height="150">
        <div class="card-overlay bg-ba-theme opacity-95"></div>
        <div class="card-overlay dark-mode-tint"></div>
        <div class="card-bg"></div>
    </div>
    @if (result.Count > 0)
    {
        <div class="card card-style">
            <div class="content mt-0 mb-0">
                <div class="input-style input-style-2 mt-3">
                    <span class="color-highlight input-style-1-active">Search Tradesperson</span>
                    <input type="text" id="searchInput" placeholder="Search Tradesperson name..." class="mb-3" />
                </div>
            </div>
        </div>
        foreach (var item in result)
        {
            <a class="card card-style trades-item" href="/MobileApp/Home/ServiceDetails?scid=@Request.QueryString["scid"]&cid=@Request.QueryString["cid"]&PostalCodeID=@Request.QueryString["PostalCodeID"]&serviceid=@Request.QueryString["sid"]&pid=@item.Id">
                <div class="content mt-0 mb-0">
                    <div class="row mb-3">
                        <div class="col-3"><img src="@item.ProfileImage" style="height: 70px; width: 70px" class="img-thumbnail mt-2"></div>
                        <div class="col-9">
                            <h4 class="mt-2">@item.ProviderName</h4>
                            <div class="font-500" style="display: flex;">
                                <div class="product-reviews-summary">
                                    <div class="rating-summary">
                                        <h4 class="rating-result"><span style="width:@item.AverageRating%"></span></h4>
                                    </div>
                                </div>
                                <span class="font-12" style="line-height: 26px;margin-left: 10px;"> (@item.ReviewsCount+ reviews)</span>
                            </div>
                            <h5 class="font-400 font-14"><i class="fa fa-map-marker m-0 font-12"></i> Operates in @item.AreaName</h5>
                        </div>
                        <div class="col-12">
                            <h4 class="font-500 mt-2 mb-2">Services <i class="font-13 fa fa-chevron-circle-right"></i></h4>
                            @foreach (var service in item.Services)
                            {
                                <span class="list-services font-13 font-500"><i class="fa pull-left fa-check m-0 font-10"></i> <span>@service</span></span>
                            }
                        </div>
                    </div>
                </div>
            </a>
        }

        <script>
            document.getElementById("searchInput").addEventListener("keyup", function () {
                const filter = this.value.toLowerCase();
                const items = document.querySelectorAll(".trades-item");

                items.forEach(item => {
                    const name = item.querySelector("h4").textContent.toLowerCase();
                    item.style.display = name.includes(filter) ? "" : "none";
                });
            });
        </script>
    }
    else
    {
        <div class="card card-style">
            <div class="content mt-0 mb-0">
                <h5 class="mt-2 font-500 text-center pb-2">No tradesperson in your area</h5>
            </div>
        </div>
        <div class="card card-style">
            <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcimpXOj5Dp3IYAnXTyiTOOYnLFE-1-to&callback=initMap" async defer></script>

            <script>
                let map;
                let markers = [];
                let infoWindow; // single shared info window

                function initMap() {
                    map = new google.maps.Map(document.getElementById("map"), {
                        center: { lat: 25.276987, lng: 55.296249 },
                        zoom: 8
                    });

                    infoWindow = new google.maps.InfoWindow(); // initialize one instance

                    loadAreaMarkers();
                }

                function loadAreaMarkers() {
                    var sid = @Request.QueryString["sid"];
                    $.ajax({
                        url: "/api/HomeApi/GetTradesPersonInCategory?sid=" + sid,
                        method: "GET",
                        timeout: 0,
                        success: function (response) {
                            if (response && response.length > 0) {
                                // Clear old markers
                                markers.forEach(m => m.setMap(null));
                                markers = [];

                                response.forEach(area => {
                                    if (area.Latitude && area.Longitude) {
                                        const position = {
                                            lat: parseFloat(area.Latitude),
                                            lng: parseFloat(area.Longitude)
                                        };

                                        const marker = new google.maps.Marker({
                                            position: position,
                                            map: map,
                                            title: `${area.AreaName} (${area.ProviderCounts} providers)`
                                        });

                                        // Reuse the single info window
                                        marker.addListener("click", () => {
                                            const content = `
                                                <a href="/MobileApp/Home/TradesPerson?sid=@Request.QueryString["sid"]&scid=@Request.QueryString["scid"]&cid=@Request.QueryString["cid"]&CityID=${ area.CityID}&PostalCodeID=${area.Id}">
                                                    <h5 style="margin-bottom: 5px;">${area.AreaName}</h5>
                                                    <h6 style="margin-right: 10px;">${area.ProviderCounts} Active Tradespersons</h6>
                                                </div>
                                            `;
                                            infoWindow.setContent(content);
                                            infoWindow.open(map, marker);
                                        });

                                        markers.push(marker);
                                    }
                                });

                                // Adjust map to fit all markers
                                const bounds = new google.maps.LatLngBounds();
                                markers.forEach(m => bounds.extend(m.getPosition()));
                                map.fitBounds(bounds);
                            } else {
                                $("#maptrades").html("");
                                console.warn("No areas found");
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("Error loading areas:", error);
                        }
                    });
                }
            </script>
            <div class="content mt-0 mb-0" id="maptrades">
                <h5 class="mt-2 font-500 text-center pb-2">Zoom in to see nearest tradesperson for this category. (Click on red marker to view details)</h5>
                <div id="map" style="height: 500px; width: 100%;"></div>
            </div>
        </div>
    }
</div>

